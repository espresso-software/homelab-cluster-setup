---
- name: Configure k3s vip
  hosts: k3s_managers
  gather_facts: true
  become: true
  tags:
    - haproxy
    - server
    - agent
  roles:
    - haproxy

- name: Complete k3s prereqs
  hosts: k3s
  gather_facts: true
  become: true
  tags:
    - prereq
    - server
    - agent
  roles:
    - k3s-prereq

- name: Initialize k3s servers
  hosts: k3s_managers
  gather_facts: true
  become: true
  tags:
    - init-managers
    - server
    - agent
  roles:
    - k3s-server

- name: Join k3s - workers
  hosts: k3s_workers
  gather_facts: true
  become: true
  tags:
    - init-workers
    - agent
  roles:
    - k3s-agent

- name: Apply cluster configurations
  hosts: k3s_managers
  gather_facts: true
  become: true
  run_once: true
  environment:
    KUBECONFIG: "{{ kube_config_path }}"
  tags:
    - cluster-config
    - server
    - agent
  roles:
    - k3s-config
