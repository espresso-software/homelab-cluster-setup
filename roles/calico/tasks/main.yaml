---
- name: Create tigera-operator namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: tigera-operator

- name: Update helm chart
  kubernetes.core.helm_repository:
    name: projectcalico
    repo_url: https://docs.tigera.io/calico/charts
    state: present

- name: Deploy Calico with helm
  kubernetes.core.helm:
    name: calico
    state: present
    namespace: tigera-operator
    chart_ref: projectcalico/tigera-operator
    values:
      installation:
        enabled: true
        calicoNetwork:
          ipPools:
            - cidr: "{{ cluster_cidr }}"
              encapsulation: VXLAN
          containerIPForwarding: 'Enabled'
        typhaDeployment:
          spec:
            template:
              spec:
                tolerations:
                  - key: "node-role.kubernetes.io/control-plane"
                    operator: "Exists"
                    effect: "NoSchedule"
                nodeSelector:
                  node-role.kubernetes.io/control-plane: "true"
        serviceCIDRs: 
          "{{ service_cidrs }}"
      defaultFelixConfiguration:
        enabled: true
        wireguardEnabled: true
        wireguardEnabledV6: true

- name: Set BGP Configuration
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: projectcalico.org/v3
      kind: BGPConfiguration
      metadata:
        name: default
      spec:
        serviceClusterIPs:
          - "{{ service_cidrs[0] }}"
        serviceExternalIPs:
          - "{{ service_cidrs[1] }}"
          - "{{ service_cidrs[2] }}"
          - "{{ service_cidrs[3] }}"

- name: Set BGP Peer with Router
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: projectcalico.org/v3
      kind: BGPPeer
      metadata:
        name: "{{ item.name }}"
      spec:
        peerIP: "{{ item.peer_ip }}"
        asNumber: 65420
        nodeSelector: "{{ item.node_selector }}"
  with_items:
    - name: "dream-machine-mgrs"
      peer_ip: "{{ manager_gateway }}"
      node_selector: "node-role.kubernetes.io/control-plane == 'true'"
    - name: "dream-machine-wkrs"
      peer_ip: "{{ worker_gateway }}"
      node_selector: "node-role.kubernetes.io/control-plane != 'true'"