---
- name: Add Longhorn Helm Repo
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: https://charts.longhorn.io
    state: present

- name: Create Longhorn Namespace
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: longhorn-system
    state: present

- name: Create Longhorn LimitRange
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: LimitRange
      metadata:
        name: longhorn-limits
        namespace: longhorn-system
      spec:
        limits:
          - defaultRequest:
              memory: 128Mi
              cpu: 100m
            type: Container
    state: present

- name: Install Longhorn
  kubernetes.core.helm:
    name: longhorn
    chart_ref: longhorn/longhorn
    release_namespace: longhorn-system
    values:
      persistence:
        defaultDataLocality: "best-effort"
      longhornDriver:
        nodeSelector:
          node-role.kubernetes.io/control-plane: "true"
  run_once: true

- name: Create Longhorn Service
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: longhorn-service
        namespace: longhorn-system
        annotations:
          metallb.universe.tf/allow-shared-ip: longhorn
          metallb.universe.tf/loadBalancerIps: "{{ longhorn_ip }}"
      spec:
        ports:
          - port: 80
            targetPort: 80
            protocol: TCP
        selector:
          app: longhorn
    state: present
