---
- name: Check if K3s is already running
  ansible.builtin.systemd:
    name: k3s
  register: k3s_status
  changed_when: false

- name: Install k3s server binaries
  when: k3s_status.status.SubState != 'running'
  ansible.builtin.command:
    cmd: /usr/local/bin/k3s-install.sh
  environment:
    INSTALL_K3S_SKIP_START: "true"
    INSTALL_K3S_VERSION: "{{ k3s_version }}"
  changed_when: true

- name: Install Ansible K3S dependencies
  when: ansible_distribution == 'Rocky'
  block:
    - name: Install pip
      ansible.builtin.package:
        name: python3-pip
        state: present
    - name: Install Ansible dependencies
      ansible.builtin.pip:
        name:
          - pyyaml
          - kubernetes
  rescue:
    - name: '[WARNING] Failed to install Ansible dependencies'
      ansible.builtin.debug:
        msg: 'Failed to install Ansible dependencies, check logs'

- name: Install Ansible K3S dependencies Ubuntu'
  when: ansible_distribution in 'Ubuntu'
  block:
    - name: Install pip
      ansible.builtin.package:
        name:
          - python3-yaml
          - python3-kubernetes
          - python3-pip
        state: present
  rescue:
    - name: '[WARNING] Failed to install Ansible dependencies'
      ansible.builtin.debug:
        msg: 'Failed to install Ansible dependencies, check logs'

- name: Create k3s group
  ansible.builtin.group:
    name: k3s
    state: present

- name: Add ansible and devops user to k3s group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: k3s
    append: true
  loop:
    - ansible
    - devops
  failed_when: false

- name: Create k3s directory
  ansible.builtin.file:
    path: /etc/rancher/k3s
    state: directory
    owner: root
    group: k3s
    mode: '0755'

- name: Create k3s config file
  ansible.builtin.template:
    src: config.yaml.j2
    dest: /etc/rancher/k3s/config.yaml
    owner: root
    group: k3s
    mode: '0640'

- name: Create k3s config directory
  ansible.builtin.file:
    path: /etc/rancher/k3s/config.yaml.d
    state: directory
    owner: root
    group: k3s
    mode: '0640'

- name: Init first k3s server
  when: inventory_hostname == managers[0].name
  block:
    - name: Create k3s config-init config yaml
      ansible.builtin.template:
        src: config-init.yaml.j2
        dest: /etc/rancher/k3s/config.yaml.d/init.yaml
        owner: root
        group: k3s
        mode: '0640'

    - name: Setup k3s if not running
      when: k3s_status.status != 'running'
      block:
        - name: Copy k3s service file [HA]
          ansible.builtin.template:
            src: k3s.service.j2
            dest: /etc/systemd/system/k3s.service
            owner: root
            group: root
            mode: '0644'

        - name: Enable and check K3s service
          ansible.builtin.systemd:
            name: k3s
            daemon_reload: true
            state: started
            enabled: true

    - name: Verify that all server nodes joined
      become: true
      ansible.builtin.command: >
          /usr/local/bin/kubectl get nodes -l "node-role.kubernetes.io/control-plane=true" -o=jsonpath="{.items[*].metadata.name}"
      register: nodes
      until: nodes.rc == 0 and (nodes.stdout.split() | length) >= 1
      retries: 20
      delay: 5
      changed_when: false

    - name: Wait for token
      ansible.builtin.wait_for:
        path: /var/lib/rancher/k3s/server/token

    - name: Wait for agent token
      ansible.builtin.wait_for:
        path: /var/lib/rancher/k3s/server/agent-token

    - name: Read k3s server token
      no_log: true
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/token
      register: k3s_token_content

    - name: Read k3s agent token
      no_log: true
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/agent-token
      register: k3s_agent_token_content

    - name: Store k3s server token
      no_log: true
      ansible.builtin.set_fact:
        k3s_token: "{{ k3s_token_content.content | b64decode | trim }}"

    - name: Store k3s agent token
      no_log: true
      ansible.builtin.set_fact:
        k3s_agent_token: "{{ k3s_agent_token_content.content | b64decode | trim }}"

- name: Start other servers
  when:
    - managers | length > 1
    - inventory_hostname != managers[0].name
  block:
    - name: Set k3s server token fact
      no_log: true
      ansible.builtin.set_fact:
        k3s_token: "{{ hostvars[managers[0].name].k3s_token }}"

    - name: Set k3s agent token fact
      no_log: true
      ansible.builtin.set_fact:
        k3s_agent_token: "{{ hostvars[managers[0].name].k3s_agent_token }}"

    - name: Create k3s config-ha config yaml
      ansible.builtin.template:
        src: config-ha.yaml.j2
        dest: /etc/rancher/k3s/config.yaml.d/ha.yaml
        owner: root
        group: root
        mode: '0640'

    - name: Setup k3s if not running
      when: k3s_status.status.SubState != 'running'
      block:
        - name: Copy k3s service file [HA]
          ansible.builtin.template:
            src: k3s.service.j2
            dest: /etc/systemd/system/k3s.service
            owner: root
            group: root
            mode: '0644'

        - name: Enable and check K3s service
          ansible.builtin.systemd:
            name: k3s
            daemon_reload: true
            state: started
            enabled: true

    - name: Verify that all server nodes joined
      when: (managers | length) > 1
      delegate_to: "{{ managers[0].name }}"
      ansible.builtin.command: >
        /usr/local/bin/kubectl get nodes -l "node-role.kubernetes.io/control-plane=true" -o=jsonpath="{.items[*].metadata.name}"
      register: nodes
      until: nodes.rc == 0 and (nodes.stdout.split() | length) == (managers | length)
      retries: 20
      delay: 5
      changed_when: false
