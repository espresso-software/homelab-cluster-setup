---
- name: Create pihole namespace
  run_once: true
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ pihole_namespace }}"

- name: Create LimitRange
  run_once: true
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: LimitRange
      metadata:
        name: pihole-limits
        namespace: "{{ pihole_namespace }}"
      spec:
        limits:
          - default:
              memory: 1Gi
              cpu: 1000m
            defaultRequest:
              memory: 256Mi
              cpu: 200m
            max:
              memory: 2Gi
              cpu: 2000m
            min:
              memory: 64Mi
              cpu: 25m
            type: Container

- name: Add Password Secrets
  run_once: true
  no_log: true
  kubernetes.core.k8s:
    state: present
    apply: true
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: pihole-secrets
        namespace: "{{ pihole_namespace }}"
      data:
        WEBPASSWORD: "{{ pihole_web_password | b64encode }}"

- name: Deploy Seconday
  run_once: true
  vars:
    pihole_instance: secondary
    pihole_ip: "{{ secondary_dns }}"
  kubernetes.core.k8s:
    state: present
    template: pihole.yml.j2
    apply: true

- name: Deploy Primary
  run_once: true
  vars:
    pihole_instance: primary
    pihole_ip: "{{ primary_dns }}"
  kubernetes.core.k8s:
    state: present
    template: pihole.yml.j2
    apply: true

- name: Deploy adhoc sync service
  run_once: true
  vars:
    immediate: true
  kubernetes.core.k8s:
    state: present
    template: sync.yml.j2
    apply: true

- name: Deploy recurring sync service
  run_once: true
  vars:
    immediate: false
  kubernetes.core.k8s:
    state: present
    template: sync.yml.j2
    apply: true

    