---
- name: Deploy Kubernetes Pihole
  when: kubernetes_deploy | default(false)
  block:
    - name: Create pihole namespace
      run_once: true
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: pihole
    
    - name: Create default egress policy
      run_once: true
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: default-egress
            namespace: pihole
          spec:
            podSelector: {} 
            policyTypes:
              - Egress
            egress:
              - ports:
                - protocol: TCP
                  port: 53
                - protocol: UDP
                  port: 53
              - ports:
                - protocol: TCP
                  port: 3128
                to:
                - ipBlock:
                    cidr: "{{ network.proxy | split(':') | first }}/32"

    - name: Create default pihole network policy
      run_once: true
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: default-pihole-allow
            namespace: pihole
          spec:
            podSelector:
              matchLabels:
                app: pihole
            policyTypes:
              - Ingress
              - Egress
            ingress:
              - ports:
                - protocol: TCP
                  port: 53
                - protocol: UDP
                  port: 53
            egress:
      
    - name: Create primary pihole network policy
      run_once: true
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: primary-pihole-allow
            namespace: pihole
          spec:
            podSelector:
              matchLabels:
                app: pihole
                version: primary
            policyTypes:
              - Ingress
            ingress:
              - ports:
                - protocol: TCP
                  port: 80
                from:
                - namespaeSelector:
                    matchLabels:
                      name: traefik-system
    
    - name: Create secondary pihole network policy
      run_once: true
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: secondary-pihole-allow
            namespace: pihole
          spec:
            podSelector:
              matchLabels:
                app: pihole
                version: secondary
            policyTypes:
              - Ingress
            ingress:
              - ports:
                - protocol: TCP
                  port: 80
                from:
                - podSelector:
                    matchLabels:
                      app: pihole-sync
    
    - name: Create pihole-sync network policy
      run_once: true
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: pihole-sync-network-policy
            namespace: pihole
          spec:
            podSelector:
              matchLabels:
                app: pihole-sync
            policyTypes:
              - Ingress
              - Egress
            egress:
              - ports:
                - protocol: TCP
                  port: 80
                to:
                - podSelector:
                    matchLabels:
                      app: pihole
                      version: secondary
              - ports:
                - protocol: TCP
                  port: 443
                to:
                - ipBlock:
                    cidr: "{{ network.subnets.prod_lb | split('/') | first }}/32"
  
    - name: Create LimitRange
      run_once: true
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: LimitRange
          metadata:
            name: pihole-limits
            namespace: pihole
          spec:
            limits:
              - default:
                  memory: 1Gi
                  cpu: 1000m
                defaultRequest:
                  memory: 256Mi
                  cpu: 200m
                max:
                  memory: 2Gi
                  cpu: 2000m
                min:
                  memory: 64Mi
                  cpu: 25m
                type: Container
  
    - name: Create ResourceQuota
      run_once: true
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ResourceQuota
          metadata:
            name: pihole-quota
            namespace: pihole
          spec:
            hard:
              requests.cpu: "2"
              requests.memory: 2Gi
              limits.cpu: "4"
              limits.memory: 4Gi

    - name: Add Password Secrets
      run_once: true
      no_log: true
      kubernetes.core.k8s:
        state: present
        apply: true
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: pihole-secrets
            namespace: pihole
          data:
            WEBPASSWORD: "{{ pihole_web_password | b64encode }}"

    - name: Create tmp file for Pihole Deployment
      ansible.builtin.tempfile:
        suffix: '.yml'
      register: deployment
    
    - name: Template secondary deployment
      ansible.builtin.template:
        src: "templates/secondary.yml.j2"
        dest: "{{ deployment.path }}"
    
    - name: Deploy secondary Pihole
      kubernetes.core.k8s:
        src: "{{ deployment.path }}"
        apply: yes

    - name: Template Pihole Deployment
      ansible.builtin.template:
        src: "templates/primary.yml.j2"
        dest: "{{ deployment.path }}"
    
    - name: Deploy Pihole
      kubernetes.core.k8s:
        src: "{{ deployment.path }}"
        apply: yes

#TODO: use physical firewall device
- name: Setup k3s FW Rules
  when: kubernetes_firewall | default(false)
  community.general.ufw:
    rule: allow
    direction: in
    src: "{{ network.identifier }}.{{ network.subnet }}"
    dest: "{{ network.dns1 }}"
    port: 53
    proto: "{{ item.proto }}"
    comment: "{{ item.comment }}"
  with_items:
    - proto: 'udp'
      comment: 'DNS UDP'
    - proto: 'tcp'
      comment: 'DNS TCP'

- name: Setup k3s FW Rules
  when: kubernetes_firewall | default(false)
  community.general.ufw:
    rule: allow
    direction: in
    src: "{{ network.identifier }}.{{ network.subnet }}"
    dest: "{{ network.dns2 }}"
    port: 53
    proto: "{{ item.proto }}"
    comment: "{{ item.comment }}"
  with_items:
    - proto: 'udp'
      comment: 'DNS UDP'
    - proto: 'tcp'
      comment: 'DNS TCP'

    