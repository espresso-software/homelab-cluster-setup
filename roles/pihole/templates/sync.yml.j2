apiVersion: v1
kind: {{ immediate | ternary('Job', 'CronJob') }}
metadata:
  name: pihole-sync
  namespace: {{ pihole_namespace }}
  labels:
    app: pihole-sync
spec:
{% if immediate %}
  parallelism: 1
  completions: 1
  template:
    {{ job_template }}
{% else %}
  schedule: "*/5 * * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    metadata:
      labels:
        app: pihole-sync
    spec:
      parallelism: 1
      completions: 1
      template:
        {{ job_template }}
{% endif %}
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: pihole-sync-network-policy
  namespace: {{ pihole_namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: pihole-sync
  ingress:
    - {}
  egress:
    - toEndpoints:
        - matchLabels:
            app: pihole
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
---