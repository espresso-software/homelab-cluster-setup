---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true

- name: Perform safe upgrade
  ansible.builtin.apt:
    upgrade: true

- name: Perform auto-remove
  ansible.builtin.apt:
    autoremove: true

- name: Check if docker sock exists
  ansible.builtin.stat:
    path: /var/run/docker.sock
  register: docker_status

- name: Perform docker cleanup
  when: docker_status.stat.exists
  community.docker.docker_prune:
    builder_cache_all: true
    containers: true
    images: true
    networks: true
    volumes: true

- name: Perform k3s cleanup
  changed_when: false
  ansible.builtin.shell: crictl rmi --prune

- name: Check if /var/run/reboot-required exists
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: reboot_required

- name: Reboot if required
  when: reboot_required.stat.exists
  vars:
    node: "{{ ansible_hostname }}"
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  block:
    - name: Cordon node
      delegate_to: "{{ cluster_name }}-mgr01{{ 'pl' if cluster_name == 'game' else 'vl' }}"
      kubernetes.core.k8s_drain:
        name: "{{ node }}"
        state: drain
        delete_options:
          delete_emptydir_data: true
          ignore_daemonsets: true
          wait_timeout: 0

    - name: Reboot
      ansible.builtin.reboot:
        msg: "[ANSIBLE] Rolling restart"
        post_reboot_delay: 60

    - name: Wait for all k8s nodes to be ready
      environment:
        KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
      delegate_to: "{{ cluster_name }}-mgr{{ '02' if 'mgr01' in ansible_hostname else '01' }}{{ 'pl' if cluster_name == 'game' else 'vl' }}"
      ansible.builtin.command: kubectl wait --for=condition=Ready nodes --all --timeout=30s
      changed_when: false
      retries: 50
      delay: 15

    - name: Uncordon node
      delegate_to: "{{ cluster_name }}-mgr{{ '02' if 'mgr01' in ansible_hostname else '01' }}{{ 'pl' if cluster_name == 'game' else 'vl' }}"
      environment:
        KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
      kubernetes.core.k8s_drain:
        name: "{{ node }}"
        state: uncordon
